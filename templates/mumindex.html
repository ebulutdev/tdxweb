<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Mum Grafik Analizi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analysis-card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .result-highlight {
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body class="container mt-5">
    <h2 class="text-center mb-4">Mum Grafik Analiz Sistemi</h2>

    <div class="card analysis-card">
        <div class="card-header">
            <h5 class="mb-0">Grafik Yükleme</h5>
        </div>
        <div class="card-body">
            <form action="http://127.0.0.1:8000/upload" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="file" class="form-label">Mum Grafik Görseli Seçin</label>
                    <input type="file" name="file" class="form-control" id="file" required>
                </div>
                <button type="submit" class="btn btn-primary">Analiz Et</button>
            </form>
        </div>
    </div>

    {% if original_image %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card analysis-card">
                <div class="card-header">
                    <h5 class="mb-0">Orijinal Görsel</h5>
                </div>
                <div class="card-body text-center">
                    <img src="{{ original_image }}" class="img-fluid border">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card analysis-card">
                <div class="card-header">
                    <h5 class="mb-0">Analizli Görsel</h5>
                </div>
                <div class="card-body text-center">
                    <img src="{{ analyzed_image }}" class="img-fluid border">
                </div>
            </div>
        </div>
    </div>

    <div class="card analysis-card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Analiz Sonuçları</h5>
        </div>
        <div class="card-body">
            {% if direnc_y and destek_y %}
            <div class="mb-3">
                <span style="display:inline-block;width:16px;height:16px;background:#00c853;border-radius:3px;margin-right:6px;vertical-align:middle;"></span>
                <strong style="color:#00c853">Direnç Seviyesi (Y):</strong> <span class="result-highlight">{{ direnc_y }}</span><br>
                <span style="display:inline-block;width:16px;height:16px;background:#d50000;border-radius:3px;margin-right:6px;vertical-align:middle;"></span>
                <strong style="color:#d50000">Destek Seviyesi (Y):</strong> <span class="result-highlight">{{ destek_y }}</span>
            </div>
            {% endif %}

            {% if yorumlar %}
            <div class="alert alert-warning mt-3">
                <h6>Senaryo & Yorumlar</h6>
                <ul class="mb-0">
                    {% for y in yorumlar %}
                    <li>{{ y }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if most_touched_levels %}
            <div class="mb-3">
                <h6>En Çok Temas Edilen Seviyeler</h6>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Renk</th>
                            <th>Seviye (Y)</th>
                            <th>Dokunma Sayısı</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lvl in most_touched_levels %}
                        <tr>
                            <td>
                                {% if lvl.y > 300 %}
                                <span style="display:inline-block;width:16px;height:16px;background:#aa00ff;border-radius:3px;"></span>
                                {% else %}
                                <span style="display:inline-block;width:16px;height:16px;background:#ffab00;border-radius:3px;"></span>
                                {% endif %}
                            </td>
                            <td>{{ lvl.y }}</td>
                            <td>{{ lvl.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            {% if clusters %}
            <div class="mb-3">
                <h6>Mum Yoğunluk Kümeleri</h6>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Renk</th>
                            <th>Bölge Başlangıcı (Y1)</th>
                            <th>Bölge Sonu (Y2)</th>
                            <th>Yoğunluk</th>
                            <th>Etiket</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in clusters %}
                        {% set renk = '#001970' if c.label == 'Bolge 1' else '#0091ea' if c.label == 'Bolge 2' else '#00b8d4' if c.label == 'Bolge 3' else '#ffd600' if c.label == 'Zayıf' else '#888' %}
                        <tr>
                            <td>
                                <span style="display:inline-block;width:16px;height:16px; background: {{ renk }}; border-radius:3px;"></span>
                            </td>
                            <td>{{ c.y1 }}</td>
                            <td>{{ c.y2 }}</td>
                            <td>{{ c.strength }}</td>
                            <td style="color:{{ renk }};font-weight:bold;">{{ c.label }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card analysis-card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Çizgi Seviyelerine Uzaklık Analizi</h5>
        </div>
        <div class="card-body">
            <canvas id="trendMultiChart"></canvas>
        </div>
    </div>

    {% if probabilities %}
    <div class="card analysis-card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Olasılık Analizi</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-sm">
                <thead>
                    <tr>
                        <th>Senaryo</th>
                        <th>Olasılık (%)</th>
                        <th>Açıklama</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in probabilities %}
                    <tr>
                        <td>{{ p.type }}</td>
                        <td><strong>{{ p.prob }}</strong></td>
                        <td>{{ p.desc }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if trend_data and trend_data.labels %}
    <script>
        const trendLabels = {{ trend_data.labels|tojson }};
        const uzaklikDirenc = {{ trend_data.uzaklik_direnc|tojson }};
        const uzaklikDestek = {{ trend_data.uzaklik_destek|tojson }};
        const uzaklikMor = {{ trend_data.uzaklik_mor|tojson }};
        const uzaklikSari = {{ trend_data.uzaklik_sari|tojson }};
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('trendMultiChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [
                        {
                            label: 'Direnç (Yeşil) Uzaklığı',
                            data: uzaklikDirenc,
                            borderColor: '#00c853',
                            fill: false
                        },
                        {
                            label: 'Destek (Kırmızı) Uzaklığı',
                            data: uzaklikDestek,
                            borderColor: '#d50000',
                            fill: false
                        },
                        {
                            label: 'Mor Çizgi (Psikolojik Eşik) Uzaklığı',
                            data: uzaklikMor,
                            borderColor: '#aa00ff',
                            fill: false
                        },
                        {
                            label: 'Sarı Çizgi (Yoğunluk Bölgesi) Uzaklığı',
                            data: uzaklikSari,
                            borderColor: '#ffd600',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Çizgi Seviyelerine Uzaklık Analizi'
                        }
                    }
                }
            });
        });
    </script>
    {% endif %}
    {% endif %} <!-- Bu en dıştaki original_image için olan kapanış -->
</body>
</html>
